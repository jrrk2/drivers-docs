---
import yaml from "js-yaml";
import path from "node:path";
import { existsSync, readFileSync } from "node:fs";
import TableOfContents from "@astrojs/starlight/components/TableOfContents.astro";
import { slugify } from "../utils/slugify";

const currentPath = Astro.url.pathname;
let driverInfo: Record<string, any> = {};
let driverManufacturerDisplay = "N/A";
let driverId = "";
let yamlPath = "";

// Extract driverId from the current URL path
// Example: /mounts/sky-watcher/eqmod/ -> mounts/sky-watcher/eqmod
if (currentPath.startsWith("/")) {
  // Remove leading slash and trailing slash
  driverId = currentPath.substring(1).replace(/\/$/, "");

  const driverIdParts = driverId.split("/");

  // Only process if we have a full driver path (category/manufacturer/driver)
  if (driverIdParts.length === 3) {
    const driverCategorySlug = slugify(driverIdParts[0]);
    const driverManufacturerSlug = slugify(driverIdParts[1]);
    const driverSlug = slugify(driverIdParts[2]);

    const contentDirPath = path.resolve(
      process.cwd(),
      `src/content/docs/${driverCategorySlug}/${driverManufacturerSlug}`,
    );

    if (existsSync(contentDirPath)) {
      try {
        const yamlFileName = `${driverSlug}.yaml`;
        const potentialYamlPath = path.resolve(contentDirPath, yamlFileName);

        if (existsSync(potentialYamlPath)) {
          yamlPath = potentialYamlPath;
          const fileContents = readFileSync(yamlPath, "utf8");
          driverInfo = yaml.load(fileContents) as Record<string, any>;

          // Extract manufacturer for display
          if (driverInfo && typeof driverInfo === "object") {
            if (driverInfo.manufacturer_name) {
              driverManufacturerDisplay =
                driverInfo.manufacturer_name as string;
            } else if (driverInfo.manufacturer) {
              driverManufacturerDisplay = driverInfo.manufacturer as string;
            }
          }
        }
      } catch (e) {
        console.error(
          `StarlightRightSidebar: Error processing YAML for ${driverId}:`,
          e,
        );
      }
    }
  }
}
---

<aside class="starlight-right-sidebar">
  <h2 class="starlight__on-this-page">Driver Information</h2>
  {
    Object.entries(driverInfo).length > 0 ? (
      <ul>
        <li>
          <strong>Manufacturer:</strong> {driverManufacturerDisplay}
        </li>
        {Object.entries(driverInfo)
          .filter(
            ([key]) =>
              key.toLowerCase() !== "manufacturer" &&
              key.toLowerCase() !== "manufacturer_name" &&
              key.toLowerCase() !== "category_name" &&
              key.toLowerCase() !== "driver_name",
          )
          .map(([key, value]) => (
            <li>
              <strong>{key}:</strong> {String(value)}
            </li>
          ))}
      </ul>
    ) : (
      <p>No driver information available.</p>
    )
  }

  <hr class="starlight-sidebar-separator" />

  <TableOfContents />
</aside>

<style>
  .starlight-right-sidebar {
    padding: 1rem;
    border-left: 1px solid var(--sl-color-gray-5);
    margin-left: 1.5rem;
  }
  .starlight-right-sidebar-title {
    font-size: 1.2em;
    margin-bottom: 1rem;
  }
  .starlight-right-sidebar ul {
    list-style: none;
    padding: 0;
  }
  .starlight-right-sidebar li {
    margin-bottom: 0.5rem;
  }
</style>
