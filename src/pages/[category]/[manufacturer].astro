---
import { getCollection } from "astro:content";
import StarlightPage from "@astrojs/starlight/components/StarlightPage.astro";
import { CATEGORIES } from "../../config/categories";
import yaml from "js-yaml";
import { readFileSync, existsSync } from "node:fs";
import path from "node:path";
import { slugify } from "../../utils/slugify";

export async function getStaticPaths() {
  const allDrivers = await getCollection("docs");
  const pathMap = new Map();

  for (const driver of allDrivers) {
    const driverId = driver.id;
    const driverParts = driverId.split("/");

    if (driverParts.length >= 3) {
      const manufacturerSlug = slugify(driverParts[1]);

      // Get manufacturer name from YAML
      const yamlPath = path.resolve(
        process.cwd(),
        `src/content/docs/${driverId.replace(/\.md$/, ".yaml")}`,
      );

      let manufacturerName = manufacturerSlug;

      if (existsSync(yamlPath)) {
        try {
          const fileContents = readFileSync(yamlPath, "utf8");
          const driverInfo = yaml.load(fileContents) as Record<string, any>;
          if (driverInfo?.manufacturer_name) {
            manufacturerName = driverInfo.manufacturer_name as string;
          }
        } catch (e) {
          console.error(`Error reading YAML for ${driverId}:`, e);
        }
      }

      // Generate a path for each category this driver belongs to
      if (driver.data.categories && Array.isArray(driver.data.categories)) {
        driver.data.categories.forEach((cat: string) => {
          const categorySlug = slugify(cat);
          const categoryName =
            CATEGORIES[categorySlug as keyof typeof CATEGORIES] || categorySlug;

          const key = `${categorySlug}-${manufacturerSlug}`;
          pathMap.set(key, {
            params: { category: categorySlug, manufacturer: manufacturerSlug },
            props: { categoryName, manufacturerName },
          });
        });
      }
    }
  }

  return Array.from(pathMap.values());
}

const { category: rawCategory, manufacturer: rawManufacturer } = Astro.params;
const category = slugify(rawCategory);
const manufacturer = slugify(rawManufacturer);
const { categoryName, manufacturerName } = Astro.props;

const allDrivers = await getCollection("docs");

// Filter drivers that belong to this category AND manufacturer
const driversByManufacturer = allDrivers.filter((driver) => {
  const driverId = driver.id;
  const driverParts = driverId.split("/");

  if (driverParts.length >= 3 && slugify(driverParts[1]) === manufacturer) {
    // Check if driver's categories array includes this category
    if (driver.data.categories && Array.isArray(driver.data.categories)) {
      return driver.data.categories.some(
        (cat: string) => slugify(cat) === category,
      );
    }
  }
  return false;
});
---

<StarlightPage
  frontmatter={{
    title: `${manufacturerName} Drivers in ${categoryName}`,
    template: "splash",
  }}
>
  <div class="driver-grid">
    {
      driversByManufacturer.map((driver) => {
        const driverPath = `/${slugify(driver.id.replace(/\.md$/, ""))}`;

        // Construct path to thumbnail in public directory
        // driver.id is like "rotators/moon-lite/night-crawler-rotator-and-focuser/night-crawler-rotator-and-focuser.md"
        const driverParts = driver.id.split("/");
        const manufacturerSlug = driverParts[1]; // Get "moon-lite"
        const driverSlug = driverParts[2]; // Get "night-crawler-rotator-and-focuser"
        const thumbnailPath = `/images/drivers/${manufacturerSlug}/${driverSlug}.webp`;

        return (
          <a href={driverPath} class="driver-box">
            <img
              src={thumbnailPath}
              alt={`${driver.data.title} thumbnail`}
              class="driver-thumbnail"
            />
            <h2>{driver.data.title}</h2>
          </a>
        );
      })
    }
  </div>
</StarlightPage>

<style>
  .driver-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }

  .driver-box {
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.75rem;
    padding: 0.5rem;
    background-color: var(--sl-color-gray-6);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    text-decoration: none;
    color: inherit;
    box-shadow: var(--sl-shadow-sm);
    transition: all 0.2s ease-in-out;
  }

  .driver-box:hover {
    background-color: var(--sl-color-gray-5);
    transform: translateY(-5px);
    box-shadow: var(--sl-shadow-md);
  }

  .driver-box h2 {
    margin-top: 0.5rem;
    margin-bottom: 0.75rem;
    color: var(--sl-color-white);
    font-size: 1.5rem;
  }

  .driver-thumbnail {
    width: 200px;
    height: 200px;
    object-fit: contain;
    margin-bottom: 0.5rem;
  }
</style>
